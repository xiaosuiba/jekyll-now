<!DOCTYPE html>
<html lang="en-us">
<head><head>
    <meta name="google-site-verification" content="9vIieCe-Qpd78QOmBl63rGtIVbhY6sYyuxX3j8XWBA4" />
    <meta name="baidu-site-verification" content="LRrmH41lz7" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="ChrisLi&#39;s Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://xiaosuiba.github.io/img/home-bg-natsume4.jpg">
    <meta property="twitter:image" content="https://xiaosuiba.github.io/img/home-bg-natsume4.jpg" />
    

    
    <meta name="title" content="增量式应用 Istio 第一部分，流量管理(译文)" />
    <meta property="og:title" content="增量式应用 Istio 第一部分，流量管理(译文)" />
    <meta property="twitter:title" content="增量式应用 Istio 第一部分，流量管理(译文)" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>增量式应用 Istio 第一部分，流量管理(译文)-打雷不怕的博客 | ChrisLi Blog</title>

    <link rel="canonical" href="/2019/02/02/incremental-traffic-management/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/syntax.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>
	
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/docco.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>
</head>

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">ChrisLi&#39;s Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/categories/life">Life</a>
                    </li>
                    
                    <li>
                        <a href="/categories/tech">Tech</a>
                    </li>
                    
                    <li>
                        <a href="/categories/tips">Tips</a>
                    </li>
                    
                    
		    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
		    <li>
                        <a href="/search">SEARCH <img src="/img/search.png" height="15" style="cursor: pointer;"></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/home-bg-natsume4.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/istio" title="Istio">
                            Istio
                        </a>
                        
                    </div>
                    <h1>增量式应用 Istio 第一部分，流量管理(译文)</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
			Posted by 
			
			    Chris Li
			 
			on 
			Saturday, February 2, 2019
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2>TOC</h2>
                </header>
                <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#设置-为什么要实施-istio-流量管理功能">设置：为什么要实施 Istio 流量管理功能？</a></li>
<li><a href="#背景-istio-网格中的流量路由">背景：Istio 网格中的流量路由</a></li>
<li><a href="#实践-istio-流量路由">实践：Istio 流量路由</a></li>
<li><a href="#测试您的部署">测试您的部署</a></li>
</ul></li>
</ul>
</nav>
                
                

<blockquote>
<p>作者：Sandeep Parikh</p>

<p>翻译：李晶晶</p>

<p>原文：<a href="https://istio.io/blog/2018/incremental-traffic-management/">https://istio.io/blog/2018/incremental-traffic-management/</a></p>
</blockquote>

<p>流量管理是 Istio 提供的重要优势之一。Istio 流量管理的核心是在将通信流量和基础设施的伸缩进行解耦。如果没有 Istio 这样的服务网格，这种流量控制方式是不可能实现的。</p>

<p>例如，您希望执行一次<a href="https://martinfowler.com/bliki/CanaryRelease.html">金丝雀发布</a>。当使用 Istio 时，您可以指定 service 的 <strong>v1</strong> 版本接收 90% 的传入流量，而该 service <strong>v2</strong> 版本仅接收 10%。如果使用标准的 Kubernetes deployment，实现此目的的唯一方法是手动控制每个版本的可用 Pod 数量，例如使 9 个 Pod 运行 v1 版本，使 1 个 Pod 运行 v2 版本。这种类型的手动控制难以实现，并且随着时间的推移可能无法扩展。有关更多信息，请查看<a href="/zh/blog/2017/0.1-canary/">使用 Istio 进行金丝雀发布</a>。</p>

<p>部署现有 service 的更新时存在同样的问题。虽然您可以使用 Kubernetes 更新 deployment，但它需要将 v1 Pod 替换为 v2 Pod。使用 Istio，您可以部署 service 的 v2 版本，并使用内置流量管理机制在网络层面将流量转移到更新后的 service，然后删除 v1 版本的 Pod。</p>

<p>除了金丝雀发布和一般流量转移之外，Istio 还使您能够实现动态请求路由（基于 HTTP header）、故障恢复、重试、断路器和故障注入。有关更多信息，请查看<a href="/zh/docs/concepts/traffic-management/">流量管理文档</a>。</p>

<p>这篇文章介绍的技术重点突出了一种特别有用的方法，可以逐步实现 Istio（在这种情况下，只有流量管理功能），而无需单独更新每个 Pod。</p>

<h2 id="设置-为什么要实施-istio-流量管理功能">设置：为什么要实施 Istio 流量管理功能？</h2>

<p>当然，第一个问题是：为什么要这样做？</p>

<p>如果你是众多拥有大量团队和大型集群的组织中的一员，那么答案是很清楚的。假设 A 团队正在开始使用 Istio，并希望在 service A 上开始一些金丝雀发布，但是 B 团队还没有开始使用 Istio，所以他们没有部署 sidecar。</p>

<p>使用 Istio，A 团队仍然可以让 service B 通过 Istio 的 ingress gateway 调用 service A 来实现他们的金丝雀发布。</p>

<h2 id="背景-istio-网格中的流量路由">背景：Istio 网格中的流量路由</h2>

<p>但是，如何在不更新每个应用程序的 Pod 的情况下，使用 Istio 的流量管理功能来包含 Istio sidecar？在回答这个问题之前，让我们以高层视角，快速地看看流量如何进入 Istio 网格以及如何被路由。</p>

<p>Pod 包含一个 sidecar 代理，该代理作为 Istio 网格的一部分，负责协调 Pod 的所有入站和出站流量。在 Istio 网格中，Pilot 负责将高级路由规则转换为配置并将它们传播到 sidecar 代理。这意味着当服务彼此通信时，它们的路由决策是由客户端确定的。</p>

<p>假设您有 service A 和 service B 两个服务，他们是 Istio 网格的一部分。当 A 想要与 B 通信时，Pod A 的 sidecar 代理负责将流量引导到 service B。例如，如果你希望到 service B v1 版本和 v2 版本之间的流量按 <sup>50</sup>&frasl;<sub>50</sub> 分割，流量将按如下方式流动：</p>


<figure>
    
        <img src="https://istio.io/blog/2018/incremental-traffic-management/fifty-fifty.png" alt="50/50 流量分割" />
    
    
    <figcaption>
        <p>
        50/50 流量分割
        
            
        
        </p> 
    </figcaption>
    
</figure>


<p>如果 service A 和 B 不是 Istio 网格的一部分，则没有 sidecar 代理知道如何将流量路由到 service B 的不同版本。在这种情况下，您需要使用另一种方法来使 service A 到 service B 的流量遵循您设置的 <sup>50</sup>&frasl;<sub>50</sub> 规则。</p>

<p>幸运的是，标准的 Istio 部署已经包含了一个 <a href="/zh/docs/concepts/traffic-management/#gateway">Gateway</a>，它专门处理 Istio 网格之外的入口流量。此 Gateway 用于允许通过外部负载均衡器进入的集群外部入口流量；或来自 Kubernetes 集群，但在服务网格之外的入口流量。网关可以进行配置，对没有 Sidecar 支持的入口流量进行代理，引导流量进入相应的 Pod。这种方法允许您利用 Istio 的流量管理功能，其代价是通过入口网关的流量将产生额外的跃点。</p>


<figure>
    
        <img src="https://istio.io/blog/2018/incremental-traffic-management/fifty-fifty-ingress-gateway.png" alt="使用 Ingress Gateway 的 50/50 流量分割" />
    
    
    <figcaption>
        <p>
        使用 Ingress Gateway 的 50/50 流量分割
        
            
        
        </p> 
    </figcaption>
    
</figure>


<h2 id="实践-istio-流量路由">实践：Istio 流量路由</h2>

<p>一种实践的简单方法是首先按照<a href="/zh/docs/setup/kubernetes/platform-setup/">平台设置</a>说明设置 Kubernetes 环境，然后使用 <a href="/zh/docs/setup/kubernetes/minimal-install/">Helm</a> 安装仅包含流量管理组件（ingress gateway、egress gateway、Pilot）的 Istio。下面的示例使用 <a href="https://cloud.google.com/gke">Google Kubernetes Engine</a>。</p>

<p>首先，<strong>安装并配置 <a href="/zh/docs/setup/kubernetes/platform-setup/gke/">GKE</a></strong>：</p>

<pre><code class="language-bash">$ gcloud container clusters create istio-inc --zone us-central1-f
$ gcloud container clusters get-credentials istio-inc
$ kubectl create clusterrolebinding cluster-admin-binding \
   --clusterrole=cluster-admin \
   --user=$(gcloud config get-value core/account)
</code></pre>

<p>然后，<strong><a href="https://docs.helm.sh/using_helm/#installing-helm">安装 Helm</a> 并<a href="/zh/docs/setup/kubernetes/minimal-install/">生成 Istio 最小配置安装</a></strong> &ndash; 只有流量管理组件：</p>

<pre><code class="language-bash">$ helm template install/kubernetes/helm/istio \
  --name istio \
  --namespace istio-system \
  --set security.enabled=false \
  --set galley.enabled=false \
  --set sidecarInjectorWebhook.enabled=false \
  --set mixer.enabled=false \
  --set prometheus.enabled=false \
  --set global.proxy.envoyStatsd.enabled=false \
  --set pilot.sidecar=false &gt; istio-minimal.yaml
</code></pre>

<p>然后<strong>创建 istio-system namespace 并部署 Istio</strong>：</p>

<pre><code class="language-bash">$ kubectl create namespace istio-system
$ kubectl apply -f istio-minimal.yaml
</code></pre>

<p>然后，在没有 Istio sidecar 容器的前提下<strong>部署 Bookinfo 示例</strong>：</p>

<pre><code class="language-bash">$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre>

<p>现在，<strong>配置一个新的 Gateway</strong> 允许从 Istio 网格外部访问 reviews service；一个新的 <code>VirtualService</code> 用于平均分配到 reviews service v1 和 v2 版本的流量；以及一系列新的、将目标子集与服务版本相匹配的 <code>DestinationRule</code> 资源：</p>

<pre><code class="language-bash">$ cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: reviews-gateway
spec:
  selector:
    istio: ingressgateway # 使用 istio 默认控制器
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;*&quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - &quot;*&quot;
  gateways:
  - reviews-gateway
  http:
  - match:
    - uri:
        prefix: /reviews
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 50
    - destination:
        host: reviews
        subset: v2
      weight: 50
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3
EOF
</code></pre>

<p>最后，使用 <code>curl</code> <strong>部署一个用于测试的 Pod</strong>（没有 Istio sidecar 容器）：</p>

<pre><code class="language-bash">$ kubectl apply -f samples/sleep/sleep.yaml
</code></pre>

<h2 id="测试您的部署">测试您的部署</h2>

<p>现在就可以通过 Sleep pod 使用 curl 命令来测试不同的行为了。</p>

<p>第一个示例是使用标准 Kubernetes service DNS 行为向 reviews service 发出请求（<strong>注意</strong>：下面的示例中使用了 <a href="https://stedolan.github.io/jq/"><code>jq</code></a> 来过滤 <code>curl</code> 的输出）：</p>

<pre><code class="language-bash">$ export SLEEP_POD=$(kubectl get pod -l app=sleep \
  -o jsonpath={.items..metadata.name})
$ for i in `seq 3`; do \
  kubectl exec -it $SLEEP_POD curl http://reviews:9080/reviews/0 | \
  jq '.reviews|.[]|.rating?'; \
  done
</code></pre>

<pre><code class="language-json">{
  &quot;stars&quot;: 5,
  &quot;color&quot;: &quot;black&quot;
}
{
  &quot;stars&quot;: 4,
  &quot;color&quot;: &quot;black&quot;
}
null
null
{
  &quot;stars&quot;: 5,
  &quot;color&quot;: &quot;red&quot;
}
{
  &quot;stars&quot;: 4,
  &quot;color&quot;: &quot;red&quot;
}
</code></pre>

<p>请注意我们是如何从 reviews service 的所有三个版本获得响应（<code>null</code> 来自 reviews v1 版本，它没有评级数据）并且流量没有在 v1 和 v2 版本间平均拆分。这是预期的行为，因为 <code>curl</code> 命令在 reviews service 所有三个版本之间进行 Kubernetes service 负载均衡。为了以 <sup>50</sup>&frasl;<sub>50</sub> 的流量拆分形式访问 reviews，我们需要通过 ingress Gateway 访问 service：</p>

<pre><code class="language-bash">$ for i in `seq 4`; do \
  kubectl exec -it $SLEEP_POD curl http://istio-ingressgateway.istio-system/reviews/0 | \
  jq '.reviews|.[]|.rating?'; \
  done
</code></pre>

<pre><code class="language-json">{
  &quot;stars&quot;: 5,
  &quot;color&quot;: &quot;black&quot;
}
{
  &quot;stars&quot;: 4,
  &quot;color&quot;: &quot;black&quot;
}
null
null
{
  &quot;stars&quot;: 5,
  &quot;color&quot;: &quot;black&quot;
}
{
  &quot;stars&quot;: 4,
  &quot;color&quot;: &quot;black&quot;
}
null
null
</code></pre>

<p>任务完成！这篇文章展示了如何部署仅包含流量管理组件（Pilot、ingress Gateway）的 Istio 的最小安装，然后使用这些组件将流量定向到特定版本的 reviews service。由于不是必须通过部署 Istio sidecar 代理来获得这些功能，因此几乎没有给现有工作负载或应用程序造成中断。</p>

<p>这篇文章展示了如何利用 Istio 及内置的 ingress Gateway（以及一些 <code>VirtualService</code> 和 <code>DestinationRule</code> 资源），轻松实现集群外部入口流量和集群内部服务到服务的流量管理。这种技术是增量式应用 Istio 的一个很好的例子，在 Pod 由不同团队拥有，或部署到不同命名空间的现实案例中尤其有用。</p>


                

                <hr>
                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/2019/02/02/hello-world/" data-toggle="tooltip" data-placement="top" title="Welcome to ChrisLi&#39;s Blog">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        <a href="/tags/docker" title="Docker">
                            Docker
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/istio" title="Istio">
                            Istio
                        </a>
                        
                        
                        
                        <a href="/tags/kubernetes" title="Kubernetes">
                            Kubernetes
                        </a>
                        
                        
                        
                        <a href="/tags/microservice" title="Microservice">
                            Microservice
                        </a>
                        
                        
                        
                        <a href="/tags/security" title="Security">
                            Security
                        </a>
                        
                        
                        
                        <a href="/tags/service-mesh" title="Service Mesh">
                            Service Mesh
                        </a>
                        
                        
                        
                        <a href="/tags/tips" title="Tips">
                            Tips
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href="" rel="alternate" type="application/rss+xml" title="ChrisLi&#39;s Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fa fa-circle fa-stack-2x"></i>
                               <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:xiaosuiba@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    <li>
                        <a target="_blank" href="/your%20wechat%20qr%20code%20image">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-wechat fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://github.com/xiaosuiba">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; ChrisLi&#39;s Blog , 2019
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https'){
       bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else{
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>







</body>
</html>
